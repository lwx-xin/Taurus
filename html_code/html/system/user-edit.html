<!DOCTYPE html>
<html>
<head>
<style type="text/css">
	.no-padding{
		padding: 0px;
	}
	.chosen-container-single .chosen-single{
		border: 1px solid #e5e6e7;
	}
	.custom-chosen-drop{
		width:490px !important;
		margin-left: 15px;
	}
		
	.display-none{
		display: none;
	}
</style>
</head>
<body>
    <div class="wrapper animated fadeInRight">
    	<div class="row">
            <div class="col-sm-12 no-padding">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <form class="form-horizontal m-t" id="my-form">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">账号：</label>
                                <div class="col-sm-8">
                                    <input id="userNumber" name="userNumber" class="form-control" type="text" aria-required="true">
                                    <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> 最多9个文字</span>
                                </div>
                            </div>
							<div class="form-group">
                                <label class="col-sm-3 control-label">头像：</label>
                                <div class="col-sm-8">
	                                <input name="userHeadPortrait" type="file" class="form-control" aria-required="true">
	                                <input id="userHead" name="userHead" type="input" class="form-control display-none" aria-required="true">
								</div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">昵称：</label>
                                <div class="col-sm-8">
                                    <input id="userName" name="userName" class="form-control" type="text" aria-required="true">
                                    <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> 最多15个文字</span>
                                </div>
                            </div>
                            <div class="form-group display-none" name="pwdDiv">
                                <label class="col-sm-3 control-label">密码：</label>
                                <div class="col-sm-8">
                                    <input id="userPwd" autocomplete="off" name="userPwd" class="form-control password-disc" type="text" aria-required="true">
                                </div>
                            </div>
                            <div class="form-group display-none" name="pwdDiv">
                                <label class="col-sm-3 control-label">确认密码：</label>
                                <div class="col-sm-8">
                                    <input id="password1" autocomplete="off" name="password1" class="form-control password-disc" type="text" aria-required="true">
                                    <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> <span id="pwdMsg">请再次输入您的密码</span></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">QQ：</label>
                                <div class="col-sm-8">
                                    <input id="userQq" name="userQq" class="form-control" type="text" aria-required="true">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Email：</label>
                                <div class="col-sm-8">
                                    <input id="userEmail" name="userEmail" class="form-control" type="email" aria-required="true">
                                </div>
                            </div>
							<div class="form-group">
                                <label class="col-sm-3 control-label">权限：</label>
                                <div class="col-sm-8">
	                                <select id="authId" name="authId" data-placeholder="请选择权限..." class="chosen-select " style="width:490px;" tabindex="2" aria-required="true" multiple>
	                                    <option value="">请选择权限</option>
	                                </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-8 col-sm-offset-3">
                                    <button class="btn btn-primary display-none insert-btn" type="button">提交insert</button>
                                    <button class="btn btn-primary display-none update-btn" type="button">提交update</button>
                                </div>
                            </div>
                            
                        </form>
                    </div>
                </div>
            </div>
		</div>
	</div>
</body>
<script src="../../js/common/base.js"></script>
<script type="text/javascript">

	var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
	
	var pageParams;
	$(function(){
		
		pageParams = getPageParam();

		//渲染控件
		drawElement();
		
		initData();
		
		initEvent();
	})
	
	function initEvent(){
		$(".insert-btn").click(function(){
			var param = new Object();
			param["userId"] = "";
			param["userNumber"] = $("input[name='userNumber']").val();
			param["userHead"] = $("input[name='userHead']").val();
			param["userName"] = $("input[name='userName']").val();
			param["userPwd"] = $("input[name='userPwd']").val();
			param["userQq"] = $("input[name='userQq']").val();
			param["userEmail"] = $("input[name='userEmail']").val();
			
			var authIdList = $("#authId").val();
			if(isNotNull(authIdList)){
				// var authList = new Array();
				$.each(authIdList, function(i, v){
					// authList.push({"authId":v});
					param["authList["+i+"].authId"] = v;
				});
			}
			
			ajax({
				url: requestPath.userInsert.url,
				data: param,
				type: requestPath.userInsert.type,
				success: function(data){
					if(data.status){
						closeFrame();
					}
				},
				error: function(data){
					layer.msg("err");
				}
			});
		});
		$(".update-btn").click(function(){
		
			var param = new Object();
			param["userId"] = pageParams.userId;
			param["userHead"] = $("input[name='userHead']").val();
			param["userName"] = $("input[name='userName']").val();
			param["userQq"] = $("input[name='userQq']").val();
			param["userEmail"] = $("input[name='userEmail']").val();
			
			var authIdList = $("#authId").val();
			if(isNotNull(authIdList)){
				// var authList = new Array();
				$.each(authIdList, function(i, v){
					// authList.push({"authId":v});
					param["authList["+i+"].authId"] = v;
				});
			}
			
			ajax({
				url: requestPath.userUpdate.url,
				data: param,
				type: requestPath.userUpdate.type,
				success: function(data){
					if(data.status){
						closeFrame();
					}
				},
				error: function(data){
					layer.msg("err");
				}
			});
		});
	}
	
	//渲染控件
	function drawElement(){
		
		var allAuthJson = '';
		if(isNotNull(allAuthJson)){
			var allAuth = JSON.parse(allAuthJson);
		}
		
		$('input[type="file"]' ).prettyFile();

        $("#userPwd,#password1").on("input", function(){
        	var pwd = $("#userPwd").val();
        	var pwd1 = $("#password1").val();
        	if(isNull(pwd) || isNull(pwd1)){
        		$("#pwdMsg").html("请再次输入您的密码");
        	} else if(pwd!=pwd1){
        		$("#pwdMsg").html("<span style='color:red'>两次密码不一致</span>");
        	} else {
        		$("#pwdMsg").html("");
        	}
        });
	}
	
	function initData(){
		//初始化权限下拉框
		ajax({
			url: requestPath.authList.url,
			type: requestPath.authList.type,
			success: function(data){
				if(data.status && isNotNull(data.data)){
					$.each(data.data, function(i, v){
						//权限id
						var authId = v.authId;
						//名称
						var name = v.authName;
						$("#authId").append("<option value='"+authId+"'>"+name+"</option>");
					});
				}
			},
			error: function(data){
				layer.msg("err");
			}
		});
		$(".chosen-select").chosen();
		
		if(isNull(pageParams.userId)){
			//新增用户
			$("div[name='pwdDiv']").show();
			$(".insert-btn").show();
			$(".update-btn").hide();
			return false;
		} else {
			//编辑用户
			$("div[name='pwdDiv']").hide();
			$(".insert-btn").hide();
			$(".update-btn").show();
			
			ajax({
				url: requestPath.userDetail.url,
				data: {"userId": pageParams.userId},
				type: requestPath.userDetail.type,
				success: function(data){
					if(data.status){
						$("#userNumber").val(data.data.userNumber);
						$("#userName").val(data.data.userName);
						$("#userPwd").val(data.data.userPwd);
						$("#userQq").val(data.data.userQq);
						$("#userEmail").val(data.data.userEmail);
						var authList = data.data.authList;
						if(isNotNull(authList)){
							$.each(authList, function(i, authObj){
								$("#authId option[value='"+authObj.authId+"']").attr("selected","selected");
							});
							$("#authId").trigger("chosen:updated");
							$("#authId").chosen();
						}
					}
				},
				error: function(data){
					layer.msg("err");
				}
			});
		}
	}
	
	function closeFrame(){
		//parent.layer.close(index);//关闭当前dialog
		parent.location.reload();//重新加载父页面
	}
	
</script>
</html>