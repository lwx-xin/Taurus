<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <title>H+ 后台主题UI框架 - 主页</title>

    <meta name="keywords" content="H+后台主题,后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description" content="H+是一个完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">
    <link rel="shortcut icon" href="../../img/logo.ico"> 
	
	<style>
		.wrapper-content{
			padding: 15px;
		}
		
		.link-span{
			color: blue;
			cursor:pointer;
		}
		
		.display-none{
			display: none;
		}
		
		.form-group input,select{
			width: 490px;
		}
		
	</style>
</head>
<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
			
            <div class="col-sm-3">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>系统用户</h5>
                    </div>
                    <div class="ibox-content">
						<div id="menuTree" class=""></div>
                    </div>
                </div>
            </div>
			
			<div class="col-sm-9" id="menuInfoDiv">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <form class="form-horizontal m-t" id="my-form">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">菜单名称：</label>
                                <div class="col-sm-8">
                                    <input id="menuText" name="urlPath" class="form-control" type="text" aria-required="true">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">是否为菜单组：</label>
                                <div class="col-sm-8">
	                                <select id="menuGroup" name="menuGroup" data-placeholder="请选择..." class="chosen-select" tabindex="2" aria-required="true">
										<option value="">请选择</option>
									</select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">请求：</label>
                                <div class="col-sm-8">
	                                <select id="menuUrl" name="menuUrl" data-placeholder="请选择请求地址..." class="chosen-select" tabindex="2" aria-required="true">
										<option value="">请选择</option>
									</select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">顺序：</label>
                                <div class="col-sm-8">
                                    <input id="menuOrder" name="menuOrder" class="form-control" type="number" aria-required="true">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">图标：</label>
                                <div class="col-sm-8">
	                                <!-- <select id="menuIcon" name="menuIcon" data-placeholder="请选择图标..." class="chosen-select" style="width:490px;" tabindex="2" aria-required="true">
										<option value="">请选择</option>
									</select> -->
									<input type="text" class="icon-picker"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">权限：</label>
                                <div class="col-sm-8">
	                                <select id="menuAuth" name="menuAuth" data-placeholder="请选择权限..." class="chosen-select" style="width:490px;" tabindex="2" aria-required="true" multiple>
										<option value="">请选择</option>
									</select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-8 col-sm-offset-3">
                                    <button class="btn btn-primary insert-btn" type="button">提交</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
			
        </div>
    </div>

</body>
<script src="../../js/common/base.js"></script>
<script type="text/javascript">

	$(function(){
		$(".icon-picker").iconPicker({
			"icons": [commonIcon.system_manager.value]
			// "defaultIcon": "fa fa-wrench"
		});
		
		initCodeList();
		$("#menuInfoDiv").hide();
		
		//加载数据
		initData()
		
		initEvent();
	});
	
	function initEvent(){
		//新增用户
		$(".add-user-btn").click(function(){
			layer.open({
				  type: 2,
				  title: "添加用户",
				  area: ['800px', '550px'],
				  fixed: false, //不固定
				  maxmin: true,
				  content: 'user-edit.html'
			});
		})
		//编辑用户
		$("#userDataTable").on("click",".edit-user-btn",function(){
			var userId = $(this).parents("tr").find("span[name='userId']").html();
			layer.open({
				  type: 2,
				  title: "编辑用户",
				  area: ['800px', '550px'],
				  fixed: false, //不固定
				  maxmin: true,
				  content: 'user-edit.html?userId='+userId
			});
		});
		//禁用启用 用户账号
		$("#userDataTable").on("click",".lock-user-btn,.unlock-user-btn",function(){
			var userId = $(this).parents("tr").find("span[name='userId']").html();
			var isLockBtn = $(this).hasClass("lock-user-btn");
			if(isLockBtn){
				swal({
				  title: "禁用账号",
				  text: "禁用后，账号将不能使用!",
				  icon: "warning",
				  buttons: ["取消","禁用"],
				  dangerMode: true,
				}).then((willDelete) => {
				  if (willDelete) {
					lock_unLock_user(userId, "lock");
				  } else {}
				});
			} else {
				lock_unLock_user(userId, "unlock");
			}
		});
	}
	
	function drawTree(menuData){
		$('#menuTree').treeview({
			showTags: true,
		    data: menuData,
			onNodeSelected: function (event, node) {
				$("#menuInfoDiv").show();
				loadMenuData(node.menuId);
			},
			onNodeUnselected: function(event, node){
				$("#menuInfoDiv").hide();
				loadMenuData(null);
			}
		});
	}
	
	function initData(){
		// 初始化菜单节点
		initMenuTree();
	}
	
	function loadMenuData(menuId){
		if(isNull(menuId)){
			$("#menuText").val("");
			$("#menuGroup").val("");
			$("#menuUrl").val("");
			$("#menuOrder").val("");
			$("#menuIcon").val("");
			
			$(".chosen-select").trigger("chosen:updated");
			$(".chosen-select").chosen();
		} else {
			ajax({
				url: requestPath.menuDetail.url,
				data: {"menuId": menuId},
				type: requestPath.menuDetail.type,
				success: function(data){
					if(data.status){
						$("#menuText").val(data.data.menuText);
						$("#menuGroup").val(data.data.menuText);
						$("#menuOrder").val(data.data.menuOrder);
						$("#menuIcon").val(data.data.menuIcon);
						$("#menuUrl").val(data.data.menuUrl);
						
						var authList = data.data.authList;
						if(isNotNull(authList)){
							var menuAuths = new Array();
							$.each(authList, function(i, authObj){
								menuAuths.push(authObj.authId);
							});
							$("#menuAuth").val(menuAuths);
						}
					}
					$(".chosen-select").trigger("chosen:updated");
					$(".chosen-select").chosen();
				},
				error: function(data){
				}
			});
		}
	}
	
	function initCodeList(){
		$("select[name='menuGroup']").attr("code-tag", Code.YES.group);
		$("select[name='menuUrl']").attr("code-tag", "url");
		$("select[name='menuAuth']").attr("code-tag", "auth");
		$("select[name='menuIcon']").attr("code-tag", "icon");
		loadCodeList();
	}
	
	
	/**
	 * 初始化菜单请求下拉框
	 */
	function initMenuUrlSelect(){
		ajax({
			url: requestPath.urlList.url,
			data: {"urlDelFlg": Code.DEL_FLG_1.value},
			type: requestPath.urlList.type,
			success: function(data){
				if(data.status){
					var urlList = data.data;
					$.each(urlList, function(i, urlEntity){
						$("#menuUrl").append("<option value='"+urlEntity.urlId+"'>"+urlEntity.urlPath+"</option>");
					});
				}
			},
			error: function(data){
			}
		});
	}
	
	/**
	 * 初始化菜单节点
	 */
	function initMenuTree(){
		ajax({
			url: requestPath.menuList.url,
			type: requestPath.menuList.type,
			success: function(data){
				if(data.status){
					var menuTree = processingMenuData(data.data);
					if(isNotNull(menuTree)){
						//渲染Tree
						drawTree(menuTree);
					} else {
						showInformation("提示","为查找到菜单数据","info")
					}
				}
			},
			error: function(data){
			}
		});
	}
	
	/**
	 * 将菜单列表转换成bootstrap-tree接受的格式
	 * @param {Array} menuData
	 */
	function processingMenuData(menuData){
		if(isNull(menuData)){
			return null;
		}
		
		var menuTree = new Array();
		
		$.each(menuData, function(i, menuEntityEx){
			var treeObj = convertMenuEntity(menuEntityEx);
			menuTree.push(treeObj);
		});
		return menuTree;
	}
	
	/**
	 * 转换菜单实体
	 * @param {Object} menuEntityEx
	 */
	function convertMenuEntity(menuEntityEx){
		var treeObj = new Object();
		treeObj["menuId"] = menuEntityEx.menuId;
		treeObj["text"] = menuEntityEx.menuText;
		treeObj["href"] = "";
		treeObj["state"] = { 
			checked: false, //指示一个节点是否处于checked状态，用一个checkbox图标表示。
			disabled: false, //指示一个节点是否处于disabled状态。（不是selectable，expandable或checkable）
			expanded: false, //指示一个节点是否处于展开状态。
			selected: false //指示一个节点是否可以被选择。
		};
		treeObj["selectable"] = true; //指定列表树的节点是否可选择。设置为false将使节点展开，并且不能被选择。
		
		var authNameList = new Array();
		var authList = menuEntityEx.authList;
		if(isNotNull(authList)){
			$.each(authList, function(i, authEntity){
				authNameList.push("<span>"+authEntity.authName+"</span>");
			});
		}
		treeObj["tags"] = authNameList;
		
		var nodeArr = null;
		if(isNotNull(menuEntityEx.childrens)){
			nodeArr = new Array();
			$.each(menuEntityEx.childrens, function(i, childrenMenuEntityEx){
				var childrenTreeObj = convertMenuEntity(childrenMenuEntityEx);
				nodeArr.push(childrenTreeObj);
			});
		}
		treeObj["nodes"] = nodeArr;
		return treeObj;
	}
	
</script>
</html>